<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>新增进货</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../Styles/themes/default/style.css" media="all">
    <link rel="stylesheet" href="../../../Scripts/libs/jquery-ui/jquery-ui.css">
</head>
<body>
<div class="ui-layout-west">
    <h3 class="ui-widget-header">物品类型树</h3>
    <div class="eui-col-xs2">
        <ul id="treeDemo" class="ztree"></ul>
    </div>
</div>
<div class="ui-layout-center  ">
        <!--右边内容 start-->
        <!--条件搜索 start-->
        <div class="eui-form eui-form-search">
            <!-- 查询重置按钮-->
            <div class="eui-btn-group">
                <button class="eui-btn" id="search" onclick="doSearch()">查询</button>
                <button class="eui-btn eui-btn-primary" onclick="reset()">重置</button>
            </div>
            <!--查询条件-->
            <div class="eui-form-item">
                <label class="eui-form-label">物品编号/名称：</label>
                <div class="eui-input-block">
                    <input type="text" class="eui-input" id="code" placeholder="请输入物品编号/名称">
                </div>
            </div>
            <div class="clearfix"></div>
        </div>


        <!--条件搜索 end-->


        <!--  <div class="nodataArea">暂无相关数据 !</div>-->


        <div class="infoList">
            <!--标题 start-->

            <div class="title-bar">
                <div class="eui-btn-group  float-right">
                    <!--不需要图标时可以将<i class="eui-icon">图标字符</i>去掉；开发时请删除此注释-->
                    <a href="javaScript:void(0)" class="eui-btn eui-btn-small" onclick="addUpdate('add')" id="add"  ><i class="eui-icon">&#xe654;</i>新增物品</a>
                    <a href="javaScript:void(0)" class="eui-btn eui-btn-small" onclick="importExcel()"><i class="eui-icon">&#xe502;</i>导入Excel</a>
                </div>
                <span class="title-main">
                  <i class="eui-icon eui-font20">&#xe62d;</i>
                  物品列表 &nbsp; &nbsp; &nbsp; &nbsp;
              </span>
            </div>

            <!--标题 end-->


            <!--表格 start-->
            <script type="text/html" id="barDemo">
                <div class="eui-btn-group">
                    <!--<a href="###" class="eui-btn eui-btn-primary eui-btn-mini" e-event="detail"><i class="eui-icon" title="查看">&#xe615;</i></a>-->
                    <a href="###" class="eui-btn eui-btn-primary eui-btn-mini" e-event="edit"><i class="eui-icon" title="编辑">&#xe615;</i></a>
                    <a href="###" class="eui-btn eui-btn-bug  eui-btn-mini" e-event="del"><i class="eui-icon" title="删除">&#xe640;</i></a>
                </div>
            </script>
            <script type="text/html" id="switchTpl">
                <!-- 这里的 checked 的状态只是演示 -->
                <input type="checkbox" name="see" e-skin="switch" e-text="启用|禁用" e-filter="" checked>
            </script>
            <table id="tableDemo" e-filter="tableDemoFilter"></table>
            <!--表格 end-->

        </div>

        <!--右边内容 end-->

        <!--弹出信息-->
</div>

<script type="text/html" id="layerContent">
    <form id="levelForm">
        <div class="eui-form eui-padding20">
            <input type="hidden" class="eui-input" name="productId" id="productId">
            <input type="hidden" class="eui-input" name="typeId" id="typeId">
            <div class="eui-form-item">
                <label class="eui-form-label">物品编码：</label>
                <div class="eui-input-block ">
                    <input type="text" class="eui-input" name="productCode" readonly id="productCode"/>
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">物品名称：</label>
                <div class="eui-input-block ">
                    <input type="text" class="eui-input" name="productName" id="productName"/>
                    <label  id="nameLabel" class="error" style="display: none;color: red">请在左侧树中选中类型后新增！</label>
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">物品类别：</label>
                <div class="eui-input-block">
                    <input type="text" name="productType" readonly id="productType" class="eui-input">
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">型号：</label>
                <div class="eui-input-block">
                    <input type="text" name="productModel" id="productModel" class="eui-input">
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">规格：</label>
                <div class="eui-input-block">
                    <input type="text" name="productSpec" id="productSpec" class="eui-input">
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">品牌：</label>
                <div class="eui-input-block">
                    <input type="text" name="productBrand" id="productBrand" class="eui-input">
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">单位：</label>
                <div class="eui-input-block">
                    <input type="text" name="productUnit" id="productUnit" class="eui-input">
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">采购单价：</label>
                <div class="eui-input-block">
                    <input type="text" name="inStockPrice" id="inStockPrice" class="eui-input">
                    <label  id="inStockLabel" class="error" style="display: none;color: red">请输入采购单价</label>
                </div>
            </div>
            <!--<div class="eui-form-item">-->
                <!--<label class="eui-form-label">出库单价：</label>-->
                <!--<div class="eui-input-block">-->
                    <!--<input type="text" name="outStockPrice" id="outStockPrice" class="eui-input">-->
                <!--</div>-->
            <!--</div>-->
            <div class="eui-form-item">
                <label class="eui-form-label">建议零售：</label>
                <div class="eui-input-block">
                    <input type="text" name="sellPrice" id="sellPrice" class="eui-input">
                </div>
            </div>
            <div class="eui-form-item">
                <label class="eui-form-label">备注：</label>
                <div class="eui-input-block">
                    <textarea class="eui-textarea" id="remark" name="remark"></textarea>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
    </form>
</script>
<script src="../../../Scripts/module/eui.js" charset="utf-8"></script>
<script type="text/javascript" src="../../../Scripts/jquery-1.9.0.min.js"></script>
<script src="../../../Scripts/libs/jquery-ui/jquery-ui.js" type="text/javascript"></script>
<script src="../../../Scripts/libs/jquery-ui/jquery.layout.js" type="text/javascript"></script>
<script src="../../../Scripts/plugins/jquery.cookie.js" type="text/javascript"></script>
<script src="../../../Scripts/config.js" type="text/javascript"></script>
<script src="../../../Scripts/pack.ajax.js" type="text/javascript"></script>
<script src="../../../Scripts/date2format.js" type="text/javascript"></script>

<!-- ztree-->
<script src="../../../Scripts/libs/ztree/js/jquery.ztree.core.js"></script>
<script src="../../../Scripts/libs/ztree/js/jquery.ztree.excheck.js"></script>
<script src="../../../Scripts/libs/ztree/js/jquery.ztree.exedit.js"></script>

<script>
    var form = null;
    var table= null;
    var txt = "";

    function reset() {
        $("#code").val("");
    }
    function doSearch(pId) {
        eui.use(['jquery', 'element', 'form', 'layedit', 'laydate', 'table', 'laytpl'], function () {
            table = eui.table;
            form = eui.form;
            var jQuery = eui.jQuery
                , element = eui.element
                , layer = eui.layer
                , layedit = eui.layedit
                , laydate = eui.laydate
                , laytpl = eui.laytpl;

            var getTpl = $("#layerContent").html();

            laytpl(getTpl).render({}, function (html) {
                txt = html;
            });

            $("body").layout({
                //   applyDemoStyles: true,
                spacing_open:8,
                spacing_closed:10,
                west__size:230,             //左侧初始宽度
                north__size:60,             //上侧初始宽度
                north__resizable:false,    //上侧关闭大小调整
                north__closable:false,      //上侧关闭收缩
                north__spacing_open: 0,       //上侧边框为0, 一般这个设置了上面的north__resizable和north__closable可以不用设置
                south__spacing_open: 0,
                south__size:30
            });

            //操作事件
            var active = {
                //当前菜单编辑
                add: function (othis) {
                    layer.open({
                        type: 2
                        , title: "新增物品"
                        , area: ['1200px', '60%']  //宽度
                        , offset: "c"              //类型,注意点击按钮的data-type属性，然后配合宽高度
                        , id: 'popdasd'  //防止重复弹出
                        , content: 'addProduct.html'
                        , btn: ['保存', '取消']
                        , btnAlign: 'c' //按钮居中
                        , shade: 0.3 //不显示遮罩
                        , maxmin: true
                        , yes: function () {
                            layer.closeAll();
                            layer.msg("保存成功！")
                        }, btn2: function () {
                            layer.closeAll();
                        }
                    });
                    //如有表单类的，请带上相关的JS预加载，并在以下加上重新渲染
                    form.render();
                }

            };

            $('.eui-btn').on('click', function () {
                var othis = $(this), method = othis.data('method');
                active[method] ? active[method].call(this, othis) : '';
            });


//实例1:简单表格
            table.render({
                elem: '#tableDemo'
                //   ,height: 350
                //  ,height: 'full-200'       //该项为设置表格最大化自适应高度
                , even: true //开启隔行背景
                , skin: 'row'
                , url: basePath+'/stock/product/getStockProduct' //数据接口
                ,where:{
                    typeId:pId,
                    code:$("#code").val()
                }
                , page: true
                , method: 'post'
                , cols: [[
                    {field: 'productCode', width: 100, title: '物品编码'}
                    , {field: 'productName', width: 120, title: '物品名称 ', sort: true}  //增加 edit 表示开户了编辑状态
                    , {field: 'productType', width: 100, title: '物品类型'}
                    , {field: 'productModel', width: 120, title: '型号'}
                    , {field: 'productSpec', width: 100, title: '规格'}
                    , {field: 'productBrand', width: 90, title: '品牌'}
                    , {field: 'productUnit', width: 70, title: '单位'}
                    , {field: 'inStockPrice', width: 80, title: '采购单价'}
                    , {field: 'sellPrice', width: 80, title: '建议零售'}
                    , {field: 'remark', width: 80, title: '备注'}
                    ,{field:'opear', title:'操作', width:120, toolbar: '#barDemo', unresize: true,fixed: 'right'}
                ]]
            });

            //监听表格复选框选择
            table.on('checkbox(tableDemoFilter)', function (obj) {
                console.log(obj)
            });

            //监听工具条
            table.on('tool(tableDemoFilter)', function (obj) {
                var data = obj.data;
                if (obj.event === 'detail') {
                    layer.msg('ID：' + data.id + ' 的查看操作');
                } else if (obj.event === 'del') {
                    layer.confirm('确定要删除《'+data.productName+'》该物品吗？', function (index) {
                        $.post(basePath+'/stock/product/delete',{id: data.productId},function () {
                            doSearch(pId);
                            layer.close(index);
                        });

                    });
                } else if (obj.event === 'edit') {
                    addUpdate(data,data.typeId,data.productType);

                }
            });
            //日期选择
            laydate.render({
                elem: '#dateTest'
            });
            //日期范围
            laydate.render({
                elem: '#dateTest2'
                , range: true
            });
        });
    }

    function addStock(pId) {

        var obj = $("#levelForm").serializeObject();
        $.ajax({
            type: "POST",
            url: basePath + "/stock/product/add",
            data: {
                json: JSON.stringify(obj),
            },
            dataType: 'json',
            success: function (result) {
                if (result.code == 200) {
                    doSearch(pId);
                    layer.msg("更新成功");
                } else {
                    layer.msg("更新失败，请联系管理员处理");
                }
            },
            error: function () {
                layer.msg("更新失败");
            }
        });
    }

    function updateProduct(pId) {
        var obj = $("#levelForm").serializeObject();
        $.ajax({
            type: "POST",
            url: basePath + "/stock/product/update",
            data: {
                json: JSON.stringify(obj),
            },
            dataType: 'json',
            success: function (result) {
                if (result.code == 200) {
                    doSearch(pId);
                    layer.msg("更新成功");
                } else {
                    layer.msg("更新失败，请联系管理员处理");
                }
            },
            error: function () {
                layer.msg("更新失败");
            }
        });
    }

    function addUpdate(data,pId,pName) {
        layer.open({
            type: 1
            , title: "添加物品"
            , area: ['400px', '100%']  //宽度
            , offset: "rt"              //类型,注意点击按钮的data-type属性，然后配合宽高度
            , id: 'popPage' //防止重复弹出
            , content: txt
            , btn: ['保存', '取消']
            , btnAlign: 'c' //按钮居中
            , shade: 0.3 //不显示遮罩
            , maxmin: true
            , yes: function () {
                $("#inStockLabel").hide();
                $("#nameLabel").hide();
                if($("#levelForm  [ name='productName']").val()==''){
                    $("#nameLabel").show();
                    return;
                }
                if($("#inStockPrice").val()===""){
                    $("#inStockLabel").show();
                    return;
                }
                if (data == "add") {
                    addStock(pId);
                } else {
                    updateProduct(pId);
                }
                layer.closeAll();
            }, btn2: function () {
                layer.closeAll();
            }
        });

        if(data=="add"){
            $("#productCode").val("系统生成");
            $("#productName").val("");
            $("#productType").val(pName);
            $("#typeId").val(pId);
            $("#productModel").val("");
            $("#productSpec").val("");
            $("#productBrand").val("");
            $("#productUnit").val("");
            $("#inStockPrice").val("");
            $("#sellPrice").val("");
            $("#remark").html("");
        }else {
            $("#productId").val(data.productId);
            $("#productCode").val(data.productCode);
            $("#productName").val(data.productName);
            $("#productType").val(pName);
            $("#typeId").val(pId);
            $("#productModel").val(data.productModel);
            $("#productSpec").val(data.productSpec);
            $("#productBrand").val(data.productBrand);
            $("#productUnit").val(data.productUnit);
            $("#inStockPrice").val(data.inStockPrice);
            $("#outStockPrice").val(data.outStockPrice);
            $("#sellPrice").val(data.sellPrice);
            $("#remark").html(data.remark);
        }
        form.render();
    }

    /*--用户树--*/
    $(function () {
        doSearch();
        getTree();
        fileOnclick();
    });
    // ztree
    function getTree(){
        var setting = {
            view: {
                // showLine: false,
                // showIcon: false,
                selectedMulti: false,
                dblClickExpand: true//false屏蔽掉双击事件

            },
            async:{
                enable:true,
                type:"post",
                dataType:"json",
                url: basePath+'/stock/product/type/findTree',
                otherParam:{'param':''},
                dataFilter: null,
            },
            check: {
                enable: false   //是否显示checkbox
            },
            data:{
                simpleData: {
                    enable: true,
                    idKey:"typeId",
                    pIdKey:"parentId",
                    rootPid:"0"
                }
            },
            callback:{
                onClick:function(event,treeId, treeNode, clickFlag){
                    //单击事件，单击展开
                    // var zTree = $.fn.zTree.getZTreeObj(treeId);
                    // zTree.expandNode(treeNode);
                    //查询某个部门的所有用户信息
                    if(treeNode.code === 'CD0001'){
                        doSearch();
                        $("#search").attr("onclick","doSearch()");
                        $("#add").hide();
                    }else{
                        doSearch(treeNode.code);
                        $("#search").attr("onclick","doSearch('"+treeNode.code+"')");
                        $("#add").show();
                        $("#add").attr("onclick","addUpdate('add','"+treeNode.code+"','"+treeNode.name+"')");
                    }

                    //设置部门的名称
                    // $("#orgNameTitle").text(treeNode.name);
                }
            },
            edit: {
                enable: false
            }
        };
        var zNodes=[];

        /*--用户树--*/
        $.fn.zTree.init($("#treeDemo"), setting, zNodes);
    }

    function importExcel() {
        layer.open({
            type: 1,
            title: "导入Excel",
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '220px'], //宽高
            content: '<div class="eui-row eui-bg-white eui-paddingTB15 ">\n' +
            '       <div class="eui-form">\n' +
            '            <div class="eui-form-item eui-paddingT20">\n' +
            '              <div class="eui-col-md12">\n' +
            '                <div class="eui-input-inline eui-marginL20">\n' +
            '                 <input type="text" id="fileName" class="eui-input" readonly>\n' +
            '                 <input type="file" class="eui-input" style="display: none" accept=".xls">\n' +
            '                 </div>\n' +
            '                 <div class="eui-btn-group">\n' +
            '                   <a href="javaScript:void(0)" class="eui-btn" onclick="chooseFile()">选择文件</a>\n' +
            '                   <a href="javaScript:void(0)" class="eui-btn eui-btn-primary" onclick="template()">下载模板</a>\n' +
            '                 </div>\n' +
            '               </div>\n' +
            '             </div>\n' +
            '          </div>\n' +
            '       </div>',
            btn: ['上传', '取消'],
            btnAlign: 'c', //按钮居中
            shade: 0.3, //不显示遮罩
            maxmin: true,
            yes: function () {
                layer.load("上传中");
                const da = new FormData();
                da.append("fileToUpload", $("input[type=file]")[0].files[0]);
                $.ajax({
                    url: basePath+"/stock/product/uploadExcel",
                    data: da,
                    type: "post",
                    async: true,
                    contentType: false,
                    processData: false,
                    dataType: "json",
                    success(res) {
                        if (res.code === 200) {
                            layer.closeAll();
                            layer.msg(res.data);
                            doSearch();
                        }else{
                            layer.closeAll();
                            layer.msg(res.message);
                        }
                    },
                    error(obj, msg) {
                        layer.closeAll();
                        layer.msg("插入失败！");
                    },
                });
            }, btn2: function () {
                layer.closeAll();
            }
        });
        form.render();
    }
    
    function chooseFile() {
        $("input[type=file]").click();
    }

    function template() {
        window.location.href = basePath + '/upload/template/产品库目录导入模板.xls';
    }

    function fileOnclick() {
        $("body").on("change","input[type=file]",function () {
            var arr=($(this).val()).split('\\');
            var fileName=arr[arr.length-1];
            $("#fileName").val(fileName);
        })
    }
</script>
</body>
</html>
