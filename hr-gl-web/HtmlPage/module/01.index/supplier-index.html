<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>首页</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../../Styles/themes/default/style.css" media="all">
		<link rel="stylesheet" href="../../../Scripts/libs/jquery-ui/jquery-ui.css">
	</head>

	<body>
		<div class="eui-bg-lightGray">
			<div class="eui-row eui-padding20">
				<div class="eui-col-md9">
					<div class="eui-row eui-margin10 eui-marginT0 eui-padding10 eui-tab-card  eui-borderRadiusLR1">

						<div class="eui-row  eui-padding10 eui-borderB eui-bg-white eui-borderRadiusLR1">
							<div class="eui-col-md2 eui-font18 ">
								<i class='eui-icon '>&#xe61d;</i> 工单列表
							</div>
							<div class="eui-col-md2  eui-form">
								语音提示：<input type="checkbox" name="close" checked="checked" e-filter='close' e-skin="switch" e-text="开启|关闭">
							</div>
						</div>
						<div class="eui-bg-white  eui-padding10">
							<div class=" eui-tab-card">
								<div class="eui-tab eui-tab-brief" e-filter="docDemoTabBrief">
									<ul class="eui-tab-title">
										<li class="eui-this">今日订单</li>
										<li>历史订单</li>
									</ul>
									<div class="eui-tab-content">
										<div class="eui-tab-item eui-form-item eui-show">
											<table class="eui-table" e-even e-skin="nob">
												<!--<colgroup>-->
													<!--<col width="70">-->
													<!--<col width="150">-->
													<!--<col width="70">-->
													<!--<col width="110">-->
													<!--<col width="100">-->
													<!--<col width="160">-->
													<!--<col width="160">-->
													<!--<col width="160">-->
													<!--<col>-->
												<!--</colgroup>-->
												<thead>
													<tr>
														<th>编号</th>
														<th>诊所</th>
														<th>状态</th>
														<th>下单医生</th>
														<th>客户姓名</th>
														<th>下单时间</th>
														<th>接单时间</th>
														<th>出货时间</th>
														<th>操作</th>
													</tr>

												</thead>
												<tbody id="tabBodys">
													<!--<tr>
														<td>DF201283</td>
														<td>天河门诊一部</td>
														<td>未接单</td>
														<td>刘医生</td>
														<td>王XX</td>
														<td>18079144222</td>
														<td>XX</td>
														<td>2018.11.6</td>
														<td>A类</td>
														<td class="eui-form-item">
															<a href="javaScript:orderInfo()" class="eui-btn eui-btn-small">详情</a>
															<a href="###" class="eui-btn eui-btn-small" onclick="">接单</a>
															<a href="###" class="eui-btn eui-btn-small" onclick="">已发货</a>
														</td>

													</tr>-->
												</tbody>
											</table>
										</div>
										<div class="eui-tab-item">
											<!--条件搜索 start-->
											<div class="eui-form eui-form-search">
												<!-- 查询重置按钮-->
												<div class="eui-btn-group">
													<button class="eui-btn" onclick="getAlldd()">查询</button>
													<button class="eui-btn eui-btn-primary" onclick="closes()">重置</button>
												</div>
												<!--查询条件-->
												<div class="eui-form-item">
													<label class="eui-form-label">订单编号：</label>
													<div class="eui-input-block">
														<input type="text" class="eui-input" id="dd_code" placeholder="请输入查询关键字">
													</div>
												</div>
												<!--华丽的分割线-->
												<div class="eui-form-item">
													<label class="eui-form-label">订单时间：</label>
													<div class="eui-input-block">
														<input type="text" class="eui-input" id="dateTest" placeholder="起止时间">
													</div>
												</div>
												<div class="clearfix"></div>
											</div>

											<!--条件搜索 end-->
											<div class="infoList">
												<table id="orderTable" e-filter="tableDemoFilter"></table>
												<!--表格 end-->
												<script type="text/html" id="barDemo">
													{{# if(d.order_state=="已提交"){ }}
													<div class="eui-btn-group">
														<a class="eui-btn eui-btn-primary eui-btn-mini" e-event="select"><i class="eui-icon" title="查看">&#xe615;</i></a>
														<button class="eui-btn eui-btn-primary eui-btn-mini" e-event="已接单">接单</button>
														<button class="eui-btn eui-btn-primary eui-btn-mini" e-event="未提交">退单</button>
													</div>
													{{# }else if(d.order_state=="已接单"){ }}
													<div class="eui-btn-group">
														<a class="eui-btn eui-btn-primary eui-btn-mini" e-event="select"><i class="eui-icon" title="查看">&#xe615;</i></a>
														<button class="eui-btn eui-btn-primary eui-btn-mini" e-event="已完成">出货</button>
													</div>
													{{# }else{ }}
													<div class="eui-btn-group">
														<a class="eui-btn eui-btn-primary eui-btn-mini" e-event="select"><i class="eui-icon" title="查看">&#xe615;</i></a>
													</div>
													{{# } }}
												</script>
											</div>
										</div>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>
				<div class="eui-col-md3">
					<div class="eui-row eui-margin10 eui-marginT0 eui-padding10 eui-tab-card  eui-borderRadiusLR1">
						<div class="eui-col-md12  eui-font20 eui-padding10">
							<i class="eui-icon eui-font28"></i> <span class="localTime">2018年12月24日11:19:45</span>
						</div>
					</div>
					<div class="eui-row eui-margin10 eui-padding10 eui-tab-card  eui-borderRadiusLR1">
						<div class="eui-col-md6 eui-textAlignC">
							<a href="#" class="eui-textIn1">
								<p class="eui-textNum"><span class="eui-color-blue" id="jinri">0</span> 个</p>
								<p class="name">今日订单数量</p>
							</a>
						</div>
						<div class="eui-col-md6 eui-textAlignC">
							<a href="#" class="eui-textIn1">
								<p class="eui-textNum"><span class="eui-color-yellow" id="weichuli">0</span> 个</p>
								<p class="name">未处理订单</p>
							</a>
						</div>
					</div>
					<div class="eui-row eui-margin10 eui-padding10 eui-tab-card  eui-borderRadiusLR1">
						<div class="eui-font18 eui-paddingT5">
							<i class='eui-icon eui-font24'>&#xe638;</i> 订单数量TOP
						</div>
						<table class="eui-table" e-even e-skin="nob">
							<colgroup>
								<col width="150">
								<col>
							</colgroup>
							<thead>
								<tr>
									<th>诊所名称</th>
									<th>订单数量</th>
								</tr>
							</thead>
							<tbody id="top">
								<!--<tr>
										<td>门诊一部</td>
										<td>120</td>
									</tr>
									<tr>
										<td>门诊二部</td>
										<td>113</td>
									</tr>
									<tr>
										<td>门诊三部</td>
										<td>67</td>
									</tr>-->
							</tbody>
						</table>

						<div class="eui-font18 eui-paddingT20">
							<i class='eui-icon eui-font24'>&#xe629;</i> 近六月订单统计
						</div>
						<div>
							<!-- 为ECharts准备一个具备大小（宽高）的Dom   -------HTML -->
							<div id="eui-bargragh" class="eui-charts"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../../Scripts/jquery-1.9.0.min.js"></script>
		<script src="../../../Scripts/module/eui.js" charset="utf-8"></script>

		<!--  JAVASCRIPT -->
		<!-- 引入 ECharts 文件 -->
		<script src="../../../Scripts/plugins/echarts/echarts.min.js"></script>
		<!-- 引入 macarons 主题 -->
		<script src="../../../Scripts/plugins/echarts/macarons.js"></script>
		<!-- <script src="../../../Scripts/plugins/prism/prism.js"></script> -->
		<!-- <script src="../../../Scripts/plugins/prism/line-numbers.js"></script> -->

		<script src="../../../Scripts/config.js" charset="utf-8"></script>
		<script src="../../../Scripts/libs/jquery-ui/jquery-ui.js" type="text/javascript"></script>
		<script src="../../../Scripts/libs/jquery-ui/jquery.layout.js" type="text/javascript"></script>
		<script type="text/javascript" src="../../../Scripts/date2format.js"></script>
		<script type="text/javascript" src="../../../Scripts/pack.ajax.js"></script>

		<script src="../../../Scripts/main.js" charset="utf-8"></script>

		<script>
			var layer;
			eui.use(['jquery', 'element', 'form', 'layedit', 'laydate', 'table', 'laytpl'], function() {
				var jQuery = eui.jQuery,
					element = eui.element,
					form = eui.form,
					layer = eui.layer,
					layedit = eui.layedit,
					laydate = eui.laydate,
					table = eui.table,
					laytpl = eui.laytpl;

				form.on('switch(close)', function(data) {
					if(data.elem.checked == true) {
						//现在是定时任务播放，实际开发改为有未接单的订单时就播放
						times = self.setInterval("autoPlay()", 60000);
					} else {
						window.clearInterval(times)
					}

				});

				laydate.render({
					elem: '#dateTest' //指定元素
						,
					type: 'datetime',
					range: true,
					done: function(value, date, endDate) {
						order_time1 = value.substring(0, 19);
						order_time2 = value.substring(22, 41);
					}
				});

				table.render({
					elem: '#orderTable'
						//   ,height: 350
						//  ,height: 'full-200'       //该项为设置表格最大化自适应高度
						,
					even: true //开启隔行背景
						,
					skin: 'row',
					data: tooth_order_lists

						,
					cols: [
						[{
								field: 'order_number',
								width: 90,
								title: '编号',
								sort: true
							}, {
								field: 'order_state',
								width: 60,
								title: '状态',
								sort: true
							}, {
								field: 'ORG_NAME',
								width: 120,
								title: '诊所'
							} //增加 edit 表示开户了编辑状态
							, {
								field: 'USER_NAME',
								width: 120,
								title: '下单医生'
							}, {
								field: 'order_time',
								width: 160,
								title: '下单时间',
								templet: '#switchTpl',
								templet: function(d) {
									return new Date(d.order_time).Format('yyyy-MM-dd hh:mm:ss');
								}
							}, {
								field: 'finish_time',
								width: 160,
								title: '接单时间',
								templet: '#switchTpl',
								templet: function(d) {
									if(d.finish_time != null && d.finish_time != "") {
										return new Date(d.finish_time).Format('yyyy-MM-dd hh:mm:ss');
									} else {
										return "";
									}

								}
							}, {
								field: 'mail_time',
								width: 160,
								title: '出货时间',
								templet: '#switchTpl',
								templet: function(d) {
									if(d.mail_time != null && d.mail_time != "") {
										return new Date(d.mail_time).Format('yyyy-MM-dd hh:mm:ss');
									} else {
										return "";
									}
								}
							}, {
								field: 'cust_name',
								title: '客户姓名',
								minWidth: 150
							}, {
								field: 'filed7',
								title: '操作',
								width: 120,
								toolbar: '#barDemo',
								unresize: true,
								fixed: 'right'
							}
						]
					],
					page: true,
					limits: [10, 20, 30],
					limit: 10 //每页默认显示的数量
				});

				//监听工具条
				table.on('tool(tableDemoFilter)', function(obj) {
					var data = obj.data;
					if(obj.event === 'select') {
						layer.open({
							type: 2,
							title: '订单详情',
							shadeClose: true,
							shade: 0.3,
							maxmin: true, //开启最大化最小化按钮
							area: ['1200px', '90%'],
							content: '../order/tooth-order-info.html',
							success: function(layero, index) {
								var iframeWin = window[layero.find('iframe')[0]['name']];
								iframeWin.getOne(obj.data.order_id);
							}
						});

					} else {
						$.ajax({
							type: "post",
							url: basePath + "/tooth/order/update",
							async: true,
							data: {
								str: obj.event,
								id: obj.data.order_id
							},
							success: function() {
								getAlldd();
								layer.close(index);
							}
						});
					}
				});

			});

			function orderInfo(obj) {
				layer.open({
					type: 2,
					title: '订单详情',
					shadeClose: true,
					shade: 0.3,
					maxmin: true, //开启最大化最小化按钮
					area: ['1200px', '90%'],
					content: '../order/tooth-order-info.html',
					success: function(layero, index) {
						var iframeWin = window[layero.find('iframe')[0]['name']];
						iframeWin.getOne(obj.getAttribute("name"));
					}
				});
			};

			var tooth_order_lists = []; //历史订单
			var tooth_order_lista = []; //今日订单

			var weichuli_flag = 0;
			var times;
			var order_time1 = "";
			var order_time2 = "";

			$(function() {
				getAlldd(); //获取今日订单和历史订单
				getTop(); //获取排名
				getCount(); //统计
				times = self.setInterval("autoPlay()", 60000);
			});

			//渲染
			function shuaxin(tooth_order) {
				var str = '';
				if(tooth_order.order_state == '已提交') {
					str = '<a href="###" class="eui-btn eui-btn-small" name=' + tooth_order.order_id + ' onclick="take(this)">接单</a>';
					str = str + '<a href="###" class="eui-btn eui-btn-small" name=' + tooth_order.order_id + ' onclick="take(this)">退单</a>';
				} else if(tooth_order.order_state == '已接单') {
					str = '<a href="###" class="eui-btn eui-btn-small" name=' + tooth_order.order_id + ' onclick="take(this)">出货</a>';
				}
				$('#tabBodys').append('<tr>' +
					'<td>' + tooth_order.order_number + '</td>' +
					'<td>' + tooth_order.ORG_NAME + '</td>' +
					'<td>' + tooth_order.order_state + '</td>' +
					'<td>' + tooth_order.USER_NAME + '</td>' +
					'<td>' + tooth_order.cust_name + '</td>' +
					'<td>' + getTime(tooth_order.order_time) + '</td>' +
					'<td>' + getTime(tooth_order.finish_time) + '</td>' +
					'<td>' + getTime(tooth_order.mail_time) + '</td>' +
					'<td class="eui-form-item">' +
					'<a href="###" class="eui-btn eui-btn-small" name=' + tooth_order.order_id + ' onclick="orderInfo(this)">详情</a>' + str +
					'</td>' +
					'</tr>');
			}

			//获取全部订单
			function getAlldd() {
				$('#tabBodys').html("");
				$.ajax({
					type: "post",
					url: basePath + "/tooth/order/lists",
					async: true,
					data: {
						order_number: $('#dd_code').val(),
						order_time: order_time1,
						order_times: order_time2
					},
					success: function(data) {
						tooth_order_lists = data.data;
						var flag = 0;
						if(eui.table != null) {
							eui.table.reload('orderTable', {

								data: tooth_order_lists

							});
						}
						for(var i in tooth_order_lists) {
							var tooth_order = tooth_order_lists[i];
							if(tooth_order.order_state == '已提交') {
								flag++;
								weichuli_flag = 1;
							}
						}
						$('#weichuli').html(flag);
					}
				});

				$.ajax({
					type: "post",
					url: basePath + "/tooth/order/lista",
					async: true,
					success: function(data) {
						tooth_order_lista = data.data;
						var flag = tooth_order_lista.length;
						$('#jinri').html(flag);
						for(var i in tooth_order_lista) {
							var tooth_order = tooth_order_lista[i]
							shuaxin(tooth_order);
						}
					}
				});

			}

			//获取时间
			function getTime(time) {
				if(time != '' && time != null && time != 'undefined') {
					return new Date(time).Format('yyyy-MM-dd hh:mm:ss');
				} else {
					return "";
				}

			}

			//接单和出货
			function take(obj) {
				var strs;
				if(obj.innerHTML == "接单") {
					strs = "已接单";
				} else if(obj.innerHTML == "出货") {
					strs = "已完成";
				} else {
					strs = "未提交";
				}
				$.ajax({
					type: "post",
					url: basePath + "/tooth/order/update",
					async: true,
					data: {
						str: strs,
						id: obj.getAttribute("name")
					},
					success: function() {
                        weichuli_flag=0;
						getAlldd();
					}
				});

			}

			//获取排名
			function getTop() {
				$.ajax({
					type: "post",
					url: basePath + "/tooth/order/listb",
					async: true,
					success: function(data) {
						var list = data.data;
						$('#top').html("");
						for(var i in list) {
							var maps = list[i];
							$('#top').append('<tr>' +
								'<td>' + maps.ORG_NAME + '</td>' +
								'<td>' + maps.count + '</td>' +
								'</tr>');
						}
					}
				});
		}

			//修改
			function update(flag) {

			}

			//统计
			function getCount() {
				$.ajax({
					type: "post",
					url: basePath + "/tooth/order/getCount",
					async: true,
					success: function(data) {
						var maps = data.data;
						var tongji = [];
						tongji[0] = maps.one;
						tongji[1] = maps.two;
						tongji[2] = maps.three;
						tongji[3] = maps.four;
						tongji[4] = maps.five;
						tongji[5] = maps.six;
						var yf = [];
						yf[0] = "1月";
						yf[1] = "2月";
						yf[2] = "3月";
						yf[3] = "4月";
						yf[4] = "5月";
						yf[5] = "6月";
						yf[6] = "7月";
						yf[7] = "8月";
						yf[8] = "9月";
						yf[9] = "10月";
						yf[10] = "11月";
						yf[11] = "12月";
						yf[12] = "1月";
						yf[13] = "2月";
						yf[14] = "3月";
						yf[15] = "4月";
						yf[16] = "5月";
						yf[17] = "6月";
						yf[18] = "7月";
						yf[19] = "8月";
						yf[20] = "9月";
						yf[21] = "10月";
						yf[22] = "11月";
						yf[23] = "12月";
						var yfs = [];
						var flag = Number(maps.me) + 6;
						for(var i = 0; i < 6; i++) {
							yfs[i] = yf[flag];
							flag++;
						}
						// 基于准备好的dom，初始化echarts实例(风格化图表)
						var myChart = echarts.init(document.getElementById('eui-bargragh'), 'macarons');
						// 基于准备好的dom，初始化echarts实例 （此例为柱状图）------------JAVASCRIPT
						var myChart = echarts.init(document.getElementById('eui-bargragh'));
						// 指定图表的配置项和数据
						var option = {
							//    title: {
							//      text: '入门示例'
							//    },
							tooltip: {},
							legend: {
								data: ['订单数量']
							},
							xAxis: {
								data: yfs
							},
							//       修改柱状条的颜色color
							itemStyle: {
								normal: {
									color: '#007FFF',
									shadowBlur: 200,
									shadowColor: 'rgba(0, 0, 0, 0.1)'
								}
							},
							yAxis: {},
							series: [{
								name: '订单数量',
								type: 'bar',
								data: tongji
							}]
						};
						// 使用刚指定的配置项和数据显示图表。
						myChart.setOption(option);
					}
				});
			}

			function closes() {
				$("#dateTest").val("");
				$("#dd_code").val("");
				order_time1 = "";
				order_time2 = "";
			}

			function autoPlay() {
				if(weichuli_flag == 1) {
					var myAuto = document.getElementById('myaudio');
					myAuto.play();
				}
                getAlldd(); //获取今日订单和历史订单
                getTop(); //获取排名
                getCount(); //统计
			}
		</script>
		<audio id="myaudio" src="../../../Scripts/data/tishi.mp3" hidden="true">
		</audio>
	</body>

</html>