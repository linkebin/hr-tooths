<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>订单详情</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../../Styles/themes/default/style.css" media="all">
		<link rel="stylesheet" href="../../../Styles/themes/default/cover-style.css" media="all">

	</head>

	<body id="">
		<div class="eui-paddingLR20" e-filter="docDemoTabBrief" id="xx4">
			<div class="bills-head">
				<img class="bills-logo" src="../../../Styles/images/logo-1.png" />
				<p id="orgCode"></p>
			</div>
			<div class="eui-form">
			<table class="eui-table bills-table">
				<colgroup>
				</colgroup>
				<thead>
					<tr>
						<td colspan="2" class="eui-textAlignL">
							<p id="custName">
								<span class="eui-marginR5">客人姓名</span>
								<span class="eui-marginR5">Pat Name</span>
							</p>
						</td>
						<td></td>
						<td colspan="3" class="eui-textAlignC">
							<p id="time">
								<span class="eui-marginR5">日期</span>
								<span class="eui-marginR5">Date</span>
								<span class="eui-marginR5" id="date"></span>
							</p>
						</td>

					</tr>
					<tr class="bills-blank">
						<td colspan="6">
							<hr class="eui-bg-black">
						</td>
					</tr>
					<tr class="projectFeel">
						<td  class="eui-textAlignL" ><nobr>项目名称 Treatment Ltem</nobr></td>
						<td class="eui-textAlignC"><nobr>单价  U/P</nobr></td>
						<td class="eui-textAlignC"><nobr>数量  Qty</nobr></td>
						<td class="eui-textAlignC"><nobr>应付  A/P</nobr></td>
						<td class="eui-textAlignC"><nobr>折扣% Dlscount</nobr></td>
						<td class="eui-textAlignC"><nobr>金额  Due</nobr></td>
					</tr>
					<tr class="bills-blank">
						<td colspan="6">
							<hr class="eui-bg-black">
						</td>
					</tr>
				</thead>
				<tbody class="centre-tbody eui-marginT10" id="detail">

				</tbody>
				<tbody class="bills-blank-tbody ">
					<tr class="bills-blank">
						<td colspan="6">
							<hr class="eui-bg-black">
						</td>
					</tr>
				</tbody>
				<tbody class="bottom-tbody">
					<tr>
						<td  class="eui-textAlignL" colspan="1">
							<span>合计 Total</span>
						</td>
						<td class="eui-textAlignL eui-paddingL20" colspan="1">
							<span>应付 A/P</span>
						</td>
						<td class="eui-textAlignR" colspan="1">
							<span id="oMoney">1111</span>
						</td>
						<td></td>
						<td class="eui-textAlignL" colspan="1">
							<span>实付 Due</span>
						</td>
						<td class="eui-textAlignC" colspan="1">
							<span id="money"></span><br />
						</td>
					</tr>
					<tr class="eui-marginT20">
						<td   >
							<span id="bczf">

							</span>
						</td>
						<td  class="eui-textAlignL eui-paddingL20"  colspan="1">
							<span>已付 Pald</span>

						</td>
						<td class="eui-textAlignR" colspan="1">
							<span id="prepaid"></span>
						</td>
						<td></td>
						<td class="eui-textAlignL" colspan="1">
							<span>欠费  Arress</span>
						</td>
						<td class="eui-textAlignC" colspan="1">
							<span id="arrear"></span>
						</td>
					</tr>

					<tr class="eui-marginT10">
						<td  class="eui-textAlignL"  class="" colspan="1">
							<span>客人签名</span>
							
							<br />
							<span>Singnature</span>
							
						</td>
						<td class="eui-textAlignL eui-paddingL20" colspan="1">
							<span>执行</span>
							<br />
							<span>Doctor</span>
						</td>
						<td class="eui-textAlignR " >
							<span class="" id="doctor"></span>
						</td>
						<td></td>
						<td class="eui-textAlignL" colspan="1">
								<span>收银员</span>
								<br />
								<span>Cashier</span>
						</td>
						<td class="eui-textAlignC">
							<span id="cashier"></span>
						</td>
					</tr>
				<tr>
					<td colspan="6">
						<hr class="eui-bg-black">
					</td>
				</tr>
				</tbody>
			</table>

			</div>
		</div>
		<div class="eui-btn-verify eui-paddingT10 eui-textAlignC eui-padding20" id="yc7">
			<div class="eui-font18 eui-paddingT5">
				<i class='eui-icon'>&#xe65e;</i>收费记录
			</div>
			<table id="sfrzTable" e-filter="sfrzTableFilter"></table>
		</div>
		<div class="eui-padding15 " id="xx3" style="display: none;">
			<div class="eui-tab eui-tab-brief" e-filter="docDemoTabBrief">
				<div class="eui-tab-content">
					<!--左右边距大的表单开头-->
					<div class="form-body">
						<!--左右边距小的表单开头-->
						<div class="eui-tab eui-tab-card  eui-padding10 eui-bg-white">
								<div>
									<div class="eui-row eui-searchTitle eui-marginB10">
										<div class="eui-col-md12">
											<span class="eui-panels-title1">汇总信息：</span>
										</div>
									</div>
									<div class="eui-row">
										<label class="eui-form-label">合计金额：</label>
										<div class="eui-input-inline">
											<input type="text" id="heji" e-verify="pass" autocomplete="off" placeholder="" readonly="readonly" class="eui-input">
										</div>
									</div>
									<div class="eui-row" style="margin-top: 10px;" id="yc5" hidden="">
										<label class="eui-form-label">未付金额：</label>
										<div class="eui-input-inline">
											<input type="text" id="arrears" e-verify="pass" autocomplete="off" placeholder="" readonly="readonly" class="eui-input">
										</div>
									</div>
									<div class="eui-row" style="margin-top: 10px;" id="yc1" hidden="">
										<label class="eui-form-label">收款：</label>
										<div class="eui-input-inline">
											<input type="text" id="shoukuan" e-verify="pass" autocomplete="off" placeholder="请输入付款金额" class="eui-input" onchange="shoukuan()">
										</div>
									</div>
									<div class="eui-row" style="margin-top: 10px;" id="yc2" hidden="">
										<label class="eui-form-label">找零：</label>
										<div class="eui-input-inline">
											<input type="text" id="zhaoling" e-verify="pass" autocomplete="off" placeholder="" readonly="readonly" class="eui-input">
										</div>
									</div>
									<form class="eui-form">
										<div class="eui-form-item" style="margin-top: 10px;width: 310px;" id="yc4" hidden="">
											<label class="eui-form-label">支付方式：</label>
											<div class="eui-input-block">
												<select name="sf_type" e-filter="sf_type" id="sf_type" e-verify="required">
													<option value="现金">现金</option>
													<option value="微信">微信</option>
													<option value="支付宝">支付宝</option>
													<option value="支付宝">刷卡</option>
													<option value="POS机">POS机</option>
												</select>
											</div>
										</div>
										<div class="eui-form-item" style="margin-top: 10px;width: 310px;" id="yc6" hidden="">
											<label class="eui-form-label">银行：</label>
											<div class="eui-input-block">
												<select name="bank" e-filter="sf_type" id="bank" e-verify="required">
													<option value=""></option>
													<option value="中国建设银行">中国建设银行</option>
													<option value="中国银行">中国银行</option>
													<option value="中国工商银行">中国工商银行</option>
													<option value="中国农业银行">中国农业银行</option>
													<option value="中信银行">中信银行</option>
													<option value="光大银行">光大银行</option>
													<option value="交通银行">交通银行</option>
													<option value="招商银行">招商银行</option>
													<option value="华夏银行">华夏银行</option>
												</select>
											</div>
										</div>
									</form>
								</div>
								<div class="eui-btn-verify eui-paddingT10 eui-textAlignC eui-paddingB15" id="yc3" hidden="">
									<button class="eui-btn" onclick="closes()" id="skButton">确认收费</button>
								</div>
							</div>

						</div>

						<!-- 删除分界线 -->
					</div>
					<!--左右边距小的表单结尾里面要删的东西要去掉-->
				</div>
				<!--左右边距大的表单结尾里面要删的东西要去掉-->
			</div>
			<!--表格结尾，里面需删除的部分要去掉-->
		</div>
		</div>

		<!-- 引入代码高亮显示文件 -->
		<!-- 引入代码高亮显示文件 -->
		<script src="../../../Scripts/plugins/prism/prism.js"></script>
		<script src="../../../Scripts/plugins/prism/line-numbers.js"></script>

		<script type="text/javascript" src="../../../Scripts/jquery-1.9.0.min.js"></script>
		<script src="../../../Scripts/module/eui.js" charset="utf-8"></script>
		<script type="text/javascript" src="../../../Scripts/config.js"></script>
		<script type="text/javascript" src="../../../Scripts/date2format.js"></script>
		<script src="../../../Scripts/plugins/jquery.query.js" charset="utf-8"></script>

		<script type="text/javascript">
            function preview() {
                $('#yc7').hide();
                window.print();
                $('#yc7').show();
            }
			//表单
			var id = jQuery.query.get("id");
			eui.use(['form', 'layedit', 'laydate', 'table'], function() {
				var form = eui.form,
					layer = eui.layer,
					layedit = eui.layedit,
					laydate = eui.laydate,
					table = eui.table;
				//收费记录表格
                table.render({
                    elem: '#sfrzTable'
                    ,even: true //开启隔行背景
                    ,skin:'row'
                    ,url: basePath+'/account/record/consumeLog' //数据接口
                    ,where:{
                        sfId:GetRequest()["id"],
                    }
                    ,method: 'post'
                    ,cols: [[
                         {field:'user_name', title: '收费人',width:120}
                        ,{field:'record_type', title: '收费类型',width:80}
                        ,{field:'bank', title: '收费银行',width:100}
                        ,{field:'create_time', title: '收费时间',width:160,templet:'<div>{{ new Date(d.create_time).Format("yyyy-MM-dd hh:mm:ss")}}</div>'}
                        ,{field:'record_money', title: '收费金额',width:120}
                        ,{	field: 'filed7',
                            title: '操作',
                            toolbar: '#dyBar',
                            unresize: true}    ]]
                    ,page: true
                    , limits: [10, 20, 30]
                    , limit: 10 //每页默认显示的数量
                });
                //监听工具条
                table.on('tool(sfrzTableFilter)', function(obj){
                    if(obj.event === 'detail'){
                        $("#cashier").html(obj.data.user_name);
                        $("#date").html(new Date(obj.data.create_time).Format("yyyy-MM-dd hh:mm:ss"));
                        if(obj.data.record_money< $("#money").html()){
                            $("#bczf").html("本次支付 Pay  &nbsp "+Number(obj.data.record_money).toFixed(2));
                            //计算欠费金额，计算历史已付金额
                            $.ajax({
                                type: "post",
                                url: basePath + "/cust/sfjl/getYf",
                                async: true,
                                data: {
                                    sfId: obj.data.sf_id,
                                    createTime: obj.data.create_time
                                },
                                success: function(res) {
                                    $("#prepaid").html(Number(res.data.money).toFixed(2));
									var qfMoney	 = $("#money").html()- res.data.money;
                                    $("#arrear").html(Number(qfMoney).toFixed(2));
                                    preview();
                                }
                            });
                        }else {
                            preview();
						}
                    }
                });
			});

			var tablaData = [];

			$(function() {
				$('#jz_name').val(getUserName());
				getTimes();
				$.post(basePath + "/cust/sfjl/detail", {
					id: id
				}, function(res) {
					$('#heji').val(Number(res.data.sfMoney).toFixed(2));
					$('#arrears').val(Number(res.data.arrears).toFixed(2));
					$('#money').html(Number(res.data.sfMoney).toFixed(2));
					$('#arrear').html(Number(res.data.arrears).toFixed(2));
					$('#prepaid').html((Number(res.data.sfMoney)-res.data.arrears).toFixed(2))
				});

                $.post(basePath + "/login/getOrgName", {
                    account: getAccount()
                }, function(res) {
                    $("#orgCode").html(res.data);
                });
			});
    		var sfId;
			var cust_name;
			//获取父窗口传递的数据
			window.getcustName = function(names, sexs, sfDeId, custBirth, custAge) {
                $("#xx4").hide();
			    $("#xx3").show();
				sfId = sfDeId;
				$('#baocun').hide();
				cust_name = names;
			};

            window.getDetail = function(names, sfDeId, date,time,doctor,cashier) {
                sfId = sfDeId;
                $('#baocun').hide();
                $.ajax({
                    type: "post",
                    url: basePath + "/cust/sfjl/de/getByIdlist",
                    async: true,
                    data: {
                        ids: sfDeId
                    },
                    success: function(data) {
                        var detail = "";
                        var oMoney = 0;
                        if(data.data !=null){
                            $.each(data.data,function (index,val) {
                                oMoney = oMoney + Number(val.oMoney);
                                detail = detail + '<tr class="projectFeel">' +
									'<td class="eui-textAlignL"><nobr>'+val.name+'</nobr></td>' +
									'<td class="eui-textAlignC"><nobr>'+Number(val.price).toFixed(2)+'</nobr></td>' +
									'<td class="eui-textAlignC"><nobr>'+ val.num +'</nobr>\n</td>' +
									'<td class="eui-textAlignC"><nobr>'+Number(val.oMoney).toFixed(2)+'</nobr></td>' +
									'<td class="eui-textAlignC"><nobr>'+ val.discount +"%" +'</nobr></td>' +
									'<td class="eui-textAlignC"><nobr>'+Number(val.money).toFixed(2)+'</nobr></td>' +
									'</tr>'
                            });
						}
						$("#oMoney").html(Number(oMoney).toFixed(2));
                        $("#detail").html(detail);
                    }
                });
                $('#custName').append(names);
                $("#date").html(date);
                $("#date").append("  "+time);
                $("#doctor").html(doctor);
                $("#cashier").html(cashier);
            };

			//获取时间
			function getTimes() {
				$.ajax({
					type: "post",
					url: basePath + "/customer/getdate",
					async: true,
					success: function(data) {
						$('#jz_time').val(getTime(Number(data)));
					}
				});
			}

			//时间格式转换
			function getTime(time) {
				if(time != '' && time != null && time != 'undefined') {
					return new Date(time).Format('yyyy-MM-dd');
				} else {
					return "";
				}

			}
			//关闭
			function closes() {
				$("#skButton").attr('disabled','disabled')
				var arrears = Number($("#arrears").val());
				var shoukuan = Number($("#shoukuan").val())
				var money = 0;
				if(shoukuan<=0){
				    layer.msg("请输入收款金额！");
                    $("#skButton").removeAttr('disabled');
					return;
				}
				if(arrears > shoukuan) {
					money = shoukuan;
				} else {
					money = arrears;
				}
				$.ajax({
					type: "post",
					url: basePath + "/cust/sfjl/update",
					async: true,
					data: {
						id: sfId,
						type: $('#sf_type').val(),
						money: money,
						bank: $('#bank').val()
					},
					success: function(data) {
                        layer.msg('收款成功！', {
                            icon: 1,
                            time: 2000 //2秒关闭（如果不配置，默认是3秒）
                        }, function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
					}
				});
			}
			//收款计算找零
			function shoukuan() {
				var num = (Number($('#shoukuan').val()) - Number($('#arrears').val())).toFixed(2);
				if (num > 0) {
					$('#zhaoling').val(num);
				} else {
					$('#zhaoling').val(0);
				}
			}
			window.show = function() {
				$('#yc1').show();
				$('#yc2').show();
				$('#yc3').show();
				$('#yc4').show();
				$('#yc5').show();
				$('#yc6').show();
				$('#yc7').hide();
			};
		</script>
		<script type="text/html" id="dyBar">
			<div class="eui-btn-group">
				<a class="eui-btn  eui-btn-mini" e-event="detail"><i class="eui-icon" title="打印">
					&#xe7fb;打印</i></a>
			</div>
		</script>
	</body>

</html>